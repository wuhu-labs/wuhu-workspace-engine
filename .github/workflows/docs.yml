name: Docs

on:
  push:
    branches: [main]

jobs:
  docs:
    name: Deploy DocC
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode (Swift 6.2)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Build with symbol graphs
        run: |
          xcrun swift build \
            -Xswiftc -emit-symbol-graph \
            -Xswiftc -emit-symbol-graph-dir -Xswiftc .build/symbol-graphs

      - name: Generate DocC for each target
        run: |
          mkdir -p .build/docs
          for target in WorkspaceContracts WorkspaceEngine WorkspaceScanner; do
            echo "=== Generating docs for $target ==="
            mkdir -p .build/target-symbols
            cp .build/symbol-graphs/${target}*.json .build/target-symbols/

            xcrun docc convert \
              --additional-symbol-graph-dir .build/target-symbols \
              --output-dir .build/docs/$target \
              --hosting-base-path docs/wuhu-workspace-engine/$target \
              --fallback-display-name $target \
              --fallback-bundle-identifier ai.wuhu.$target \
              --fallback-bundle-version 0.1.0

            rm -rf .build/target-symbols
          done

      - name: Deploy to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npm install -g wrangler
          for target in WorkspaceContracts WorkspaceEngine WorkspaceScanner; do
            echo "=== Deploying $target ==="
            cd .build/docs/$target
            find . -type f | while read -r file; do
              key="${file#./}"
              case "$file" in
                *.html) ct="text/html" ;;
                *.css)  ct="text/css" ;;
                *.js)   ct="application/javascript" ;;
                *.json) ct="application/json" ;;
                *.svg)  ct="image/svg+xml" ;;
                *.jpg|*.jpeg) ct="image/jpeg" ;;
                *.png)  ct="image/png" ;;
                *)      ct="application/octet-stream" ;;
              esac
              wrangler r2 object put "wuhu-site/docs/wuhu-workspace-engine/$target/$key" --file="$file" --content-type="$ct" --remote
            done
            cd ../../..
          done
